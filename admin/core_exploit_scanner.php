<?php
  // this plugin requires Last version
        if (!version_compare(get_bloginfo('version'), FDX_LAST_WP_VER,  '>=')) {
         echo '<div id="message" class="error" style="top: 250px; position: absolute; padding: 15px"><div align="center"><img src="'.FDX_PLUGIN_URL.'/images/warning.png" width="48" height="48" border="0" alt="" /></div><strong>Core Exploit Scanner</strong> requires the latest WordPress version (<a href="' . admin_url('update-core.php') . '" title="Update WP core">' . FDX_LAST_WP_VER . '</a>) to function properly. You\'re using WordPress version <strong>' . get_bloginfo('version') . '</strong>. Please <strong><a href="' . admin_url('update-core.php') . '" title="Update WP core">update</a></strong>.</div>';
    return;
    }

    $results = get_option(FDX_CS_OPTIONS_KEY);
  ?>
<div class="wrap"><?php echo get_screen_icon('sn-lock');?>
<h2><?php echo FDX2_PLUGIN_NAME;?>: <?php _e('Core Exploit Scanner', 'fdx-lang') ?></h2>
<div id="poststuff">
<div id="post-body" class="metabox-holder columns-2">

<?php include('_sidebar.php'); ?>

<div class="postbox-container">
<div class="meta-box-sortables">

<div class="postbox">
<div class="handlediv" title="<?php _e('Click to toggle', 'fdx-lang') ?>"><br /></div><h3 class='hndle'><span><?php _e('Core Exploit Scanner', 'fdx-lang') ?></span></h3>
<div class="inside">



   <?php
    echo '<p>Files are scanned and compared via the <em>MD5 hashing algorithm</em> to original WordPress core files available from <strong>wordpress.org</strong>. Not every change on core files is malicious and changes can serve a legitimate purpose. However if you are not a developer and you did not change the files yourself the changes most probably come from an exploit.</p>';
    echo '<div align="center"><input type="button" value=" One Click Scanner " id="sn-run-scan" class="button-primary" />';
    if (isset($results['last_run']) && $results['last_run']) {
      echo '<br /><code>Files were last scanned on: ' . date(get_option('date_format') . ' ' . get_option('time_format'), $results['last_run']) . '.</code><p>&nbsp;</p>';
    }
    echo '</div>';
    if ($results['changed_bad']) {
      echo '<table class="widefat">';
      echo '<thead><tr>';
      echo '<th class="sn-status" style="color:red; font-weight: bold">WP CORE FILES MODIFIED<small></th>';
      echo '</tr></thead>';
      echo '<tbody><tr><td>';
      echo '<p>If you didn\'t modify the following files and don\'t know who did they are most probably infected by a party malicious code.</p>';
      echo self::list_files($results['changed_bad'], true, true);
      echo '</td></tr></tbody>';
      echo '</table>';
    }

    if ($results['missing_bad']) {
      echo '<p>&nbsp;</p><table class="widefat">';
      echo '<thead><tr>';
      echo '<th class="sn-status" style="color:#EFA800; font-weight: bold">WP CORE FILES MISSING</th>';
      echo '</tr></thead>';
      echo '<tbody><tr><td>';
      echo '<p>Missing core files my indicate a bad auto-update or they simply were not copied on the server when the site was setup. Use the restore action to create them.</p>';
      echo self::list_files($results['missing_bad'], false, true);
      echo '</td></tr></tbody>';
      echo '</table>';
    }

    if ($results['changed_ok']) {
      echo '<p>&nbsp;</p><table class="widefat">';
      echo '<thead><tr>';
      echo '<th class="sn-status" style="color:#6FBF00; font-weight: bold">WP CORE FILES MODIFIED*</th>';
      echo '</tr></thead>';
      echo '<tbody><tr><td>';
      echo '<p>There are only two core files (<strong><em>/wp-config.php</em></strong> and <strong><em>/index.php</em></strong>) that should be modified. This is normal and one or both of them should appear on this list. You can still have a look at their source to check for any suspicious code.</p>';
      echo self::list_files($results['changed_ok'], true, false);
      echo '</td></tr></tbody>';
      echo '</table>';
    }
    if ($results['missing_ok']) {
      echo '<p>&nbsp;</p><table class="widefat">';
      echo '<thead><tr>';
      echo '<th class="sn-status" style="color:#6FBF00; font-weight: bold">WP CORE FILES MISSING*</th>';
      echo '</tr></thead>';
      echo '<tbody><tr><td>';
      echo '<p>Some files like (<strong><em>/readme.html, /license.txt, /wp-config-sample.php, /wp-admin/install.php, /wp-admin/upgrade.php</em></strong>) are not vital and should be removed. Do not restore them unless you really need them and know what you are doing.</p>';
      echo self::list_files($results['missing_ok'], false, true);
      echo '</td></tr></tbody>';
      echo '</table>';
  }

    if ($results['ok']) {
      $diference = $results['total'] - sizeof($results['ok']);
      echo '<div class="sn-cs-ok" align="center">';
      echo '<h4>A total of <span class="sn_count">' . $results['total'] . '</span> files were scanned...</h4><h4> <span class="sn_count">' . sizeof($results['ok']) . '</span> are unmodified and safe, and <span class="sn_count">'. $diference .'*</span> are files modified or missing.</h4>';
      echo '</div>';
      echo '* <em>Included files modified or missing "but allowed".</em>';
    }

    // dialogs
    echo '<div id="source-dialog" style="display: none;" title="File source"><p>Please wait.</p></div>';
    echo '<div id="restore-dialog" style="display: none;" title="Restore file"><p>Please wait.</p></div>';
    ?>

   </div>
</div>
</div>
</div>
</div>
</div>

</div>
<?php include('_footer_js.php'); ?>
<div class="clear"></div>
<script language="JavaScript" type="text/javascript">
/*<![CDATA[*/
jQuery(document).ready(function($){
  $('a.sn-show-source').click(function() {
      $($(this).attr('href')).dialog('option', { title: 'File source: ' + $(this).attr('data-file'), file_path: $(this).attr('data-file'), file_hash: $(this).attr('data-hash') } ).dialog('open');
      return false;
  });
  $('a.sn-restore-source').click(function() {
      $($(this).attr('href')).dialog('option', { title: 'Restore file source: ' + $(this).attr('data-file'), file_path: $(this).attr('data-file'), file_hash: $(this).attr('data-hash') } ).dialog('open');
      return false;
  });
  $('#source-dialog').dialog({'dialogClass': 'wp-dialog',
                              'modal': true,
                              'resizable': false,
                              'zIndex': 9999,
                              'width': 800,
                              'height': 550,
                              'hide': 'fade',
                              'open': function(event, ui) { renderSource(event, ui); fixDialogClose(event, ui); },
                              'close': function(event, ui) { jQuery('#source-dialog').html('<p>Please wait.</p>') },
                              'show': 'fade',
                              'autoOpen': false,
                              'closeOnEscape': true
                              });
  $('#restore-dialog').dialog({'dialogClass': 'wp-dialog',
                               'modal': true,
                               'resizable': false,
                               'zIndex': 9999,
                               'width': 450,
                               'height': 350,
                               'hide': 'fade',
                               'open': function(event, ui) { renderRestore(event, ui); fixDialogClose(event, ui); },
                               'close': function(event, ui) { jQuery('#restore-dialog').html('<p>Please wait.</p>') },
                               'show': 'fade',
                               'autoOpen': false,
                               'closeOnEscape': true
                              });
  // scan files
  $('#sn-run-scan').removeAttr('disabled').click(function(){
    var data = {action: 'sn_core_run_scan'};

    $(this).attr('disabled', 'disabled')
           .val('Scanning files, please wait!');
    $.blockUI({ message: '<img src="<?php echo FDX_WPSS_PLUGIN_URL; ?>images/loading2.gif" width="24" height="24" border="0" alt="" /><br />Total Security this scanning your core files, <br />Please wait, it can take a minute.' });

    $.post(ajaxurl, data, function(response) {
      if (response != '1') {
        alert('Undocumented error. Page will automatically reload.');
        window.location.reload();
      } else {
        window.location.reload();
      }
    });
  }); // run tests
}); // onload

function renderSource(event, ui) {
  dialog_id = '#' + event.target.id;

  jQuery.post(ajaxurl, {action: 'sn_core_get_file_source', filename: jQuery('#source-dialog').dialog('option', 'file_path'), hash: jQuery('#source-dialog').dialog('option', 'file_hash')}, function(response) {
      if (response) {
        if (response.err) {
          jQuery(dialog_id).html('<p><b>An error occured.</b> ' + response.err + '</p>');
        } else {
          jQuery(dialog_id).html('<pre class="sn-core-source"></pre>');
          jQuery('pre', dialog_id).text(response.source);
          jQuery('pre', dialog_id).snippet(response.ext, {style: 'whitengrey'});
        }
      } else {
        alert('An undocumented error occured. The page will reload.');
        window.location.reload();
      }
    }, 'json');
} // renderSource
function renderRestore(event, ui) {
  dialog_id = '#' + event.target.id;

  jQuery.post(ajaxurl, {action: 'sn_core_restore_file', filename: jQuery(dialog_id).dialog('option', 'file_path'), hash: jQuery(dialog_id).dialog('option', 'file_hash')}, function(response) {
      if (response) {
        if (response.err) {
          jQuery(dialog_id).html('<p><b>An error occured.</b> ' + response.err + '</p>');
        } else {
          jQuery(dialog_id).html(response.out);

            jQuery('#sn-restore-file').on('click', function(event){
              jQuery(this).attr('disabled', 'disabled').attr('value', 'Please wait ...');
              jQuery.post(ajaxurl, {action: 'sn_core_restore_file_do', filename: jQuery(this).attr('data-filename')}, function(response) {
                if (response == '1') {
                  alert('File successfully restored!\nThe page will reload and files will be rescanned.');
                  window.location.reload();
                } else {
                  alert('An error occured - ' + response);
                  jQuery(this).attr('disabled', '').attr('value', 'Restore file');
                }
              });
            });
        }
      } else {
        alert('An undocumented error occured. The page will reload.');
        window.location.reload();
      }
    }, 'json');
} // renderSource
function fixDialogClose(event, ui) {
  jQuery('.ui-widget-overlay').bind('click', function(){ jQuery('#' + event.target.id).dialog('close'); });
} // fixDialogClose
/*]]>*/
</script>