<?php
  // this plugin requires Last version
        if (!version_compare(get_bloginfo('version'), FDX2_LAST_WP_VER,  '>=')) {
         echo '<div id="message" class="error" style="top: 250px; position: absolute; padding: 15px"><div align="center"><img src="'.FDX2_PLUGIN_URL.'/images/warning.png" width="48" height="48" border="0" alt="" /></div><strong>'.__('Core Exploit Scanner', 'total-security').'</strong> '.__('requires the latest WordPress version', 'total-security').' (<a href="' . admin_url('update-core.php') . '" title="'.__('Update WP core', 'total-security').'">' . FDX2_LAST_WP_VER . '</a>) '.__('to function properly. You\'re using WordPress version', 'total-security').' (<strong>' . get_bloginfo('version') . ')</strong>. '.__('Please', 'total-security'). ' <strong><a href="' . admin_url('update-core.php') . '" title="'.__('Update WP core', 'total-security').'">'.__('update', 'total-security').'</a></strong>.</div>';
    return;
    }

    $results = get_option(FDX_CS_OPTIONS_KEY);
  ?>
<div class="wrap"><?php echo get_screen_icon('fdx-lock');?>
<h2><?php echo FDX2_PLUGIN_NAME;?>: <?php _e('Core Exploit Scanner', 'total-security') ?></h2>
<?php
/* display warning if test were never run
*------------------------------------------------------------*/
    $tests = get_option(FDX_CS_OPTIONS_KEY);
    if (!@$tests['last_run']) {
      echo '<div id="message" class="error"><p>Total Security '.__('(Core Exploit Scanner) <strong>tests were never run.</strong> Click <strong>"'.__('One Click Scanner', 'total-security'). '"</strong> to run them now and check your core files for exploits.', 'total-security').'</p></div>';
    } elseif ((current_time('timestamp') - 15*24*60*60) > $tests['last_run']) {
      echo '<div id="message" class="error"><p>Total Security '.__('(Core Exploit Scanner) <strong>tests were not run for more than 30 days.</strong> It\'s advisable to run them once in a while. Click <strong>"'.__('One Click Scanner', 'total-security'). '"</strong> to run them now check your core files for exploits.', 'total-security').'</p></div>';
    }
?>
<div id="poststuff">
<div id="post-body" class="metabox-holder columns-2">

<?php include('_sidebar.php'); ?>

<div class="postbox-container">
<div class="meta-box-sortables">

<div class="postbox">
<div class="handlediv" title="<?php _e('Click to toggle', 'total-security') ?>"><br /></div><h3 class='hndle'><span><?php _e('Core Exploit Scanner', 'total-security') ?></span></h3>
<div class="inside">



   <?php
    echo '<p>'.__('Files are scanned and compared via the <em>MD5 hashing algorithm</em> to original WordPress core files available from <strong>wordpress.org</strong>. Not every change on core files is malicious and changes can serve a legitimate purpose. However if you are not a developer and you did not change the files yourself the changes most probably come from an exploit.', 'total-security').'</p>';
    echo '<div align="center"><input type="button" value=" '.__('One Click Scanner', 'total-security'). ' " id="fdx-run-scan" class="button-primary" />';
    if (isset($results['last_run']) && $results['last_run']) {
      echo '<br /><code>'.__('Files were last scanned on', 'total-security').': ' . date(get_option('date_format') . ' ' . get_option('time_format'), $results['last_run']) . '.</code><p>&nbsp;</p>';
    } else { echo '<p><img src="'.FDX2_PLUGIN_URL.'/images/no.png" width="48" height="48" border="0" alt="" /></p>';}
    echo '</div>';
    if ($results['changed_bad']) {
      echo '<table class="widefat">';
      echo '<thead><tr>';
      echo '<th><img src="'.FDX2_PLUGIN_URL.'images/critical.png" width="32" height="32" border="0" alt="*" style="vertical-align: middle" />'.__('Core files', 'total-security').' (<strong style="color:red;">'. __('modified', 'total-security'). '</strong>)</th>';
      echo '</tr></thead>';
      echo '<tbody><tr class="alternate"><td>';
      echo '<div style="font-size: 11px">'.__('If you didn\'t modify the following files and don\'t know who did they are most probably infected by a party malicious code.', 'total-security').'</div></td></tr><td>';
      echo self::list_files($results['changed_bad'], true, true);
      echo '</td></tr></tbody>';
      echo '</table>';
    }

    if ($results['missing_bad']) {
      echo '<p>&nbsp;</p><table class="widefat">';
      echo '<thead><tr>';
      echo '<th><img src="'.FDX2_PLUGIN_URL.'images/critical.png" width="32" height="32" border="0" alt="*" style="vertical-align: middle" />'.__('Core files', 'total-security').' (<strong style="color:red;">'. __('missing', 'total-security'). '</strong>)</th>';
      echo '</tr></thead>';
      echo '<tbody><tr class="alternate"><td>';
      echo '<div style="font-size: 11px">'.__('Missing core files my indicate a bad auto-update or they simply were not copied on the server when the site was setup. Use the restore action to create them.', 'total-security').'</div></td></tr><td>';
      echo self::list_files($results['missing_bad'], false, true);
      echo '</td></tr></tbody>';
      echo '</table>';
    }

   if ($results['missing_ok']) {
      echo '<p>&nbsp;</p><table class="widefat">';
      echo '<thead><tr>';
      echo '<th><img src="'.FDX2_PLUGIN_URL.'images/clean.png" width="32" height="32" border="0" alt="*" style="vertical-align: middle" />'.__('Core files', 'total-security').' (<strong style="color:green;">'. __('missing', 'total-security'). '</strong>)</th>';
      echo '</tr></thead>';
      echo '<tbody><tr class="alternate"><td>';
      echo '<div style="font-size: 11px">'.__('Some files like (<strong><em>/readme.html, /license.txt, /wp-config-sample.php, /wp-admin/install.php, /wp-admin/upgrade.php</em></strong>) are not vital and should be removed. Do not restore them unless you really need them and know what you are doing.', 'total-security').'</div></td></tr><td>';
      echo self::list_files($results['missing_ok'], false, true);
      echo '</td></tr></tbody>';
      echo '</table>';
  }

    if ($results['changed_ok']) {
      echo '<p>&nbsp;</p><table class="widefat">';
      echo '<thead><tr>';
      echo '<th><img src="'.FDX2_PLUGIN_URL.'images/clean.png" width="32" height="32" border="0" alt="*" style="vertical-align: middle" />'.__('Config files', 'total-security').' <strong style="color:green;font-size:20px">&#10003;</strong></th>';
      echo '</tr></thead>';
      echo '<tbody><tr class="alternate"><td>';
      echo '<div style="font-size: 11px">'.__('Look at their source to check for any suspicious code.', 'total-security').'</small></td></tr><td>';
      echo self::list_files($results['changed_ok'], true, false);
      echo '</td></tr></tbody>';
      echo '</table>';
    }

      if ($results['missing_conf']) {
      echo '<p>&nbsp;</p><table class="widefat">';
      echo '<thead><tr>';
      echo '<th><img src="'.FDX2_PLUGIN_URL.'images/wan.png" width="32" height="32" border="0" alt="*" style="vertical-align: middle" />'.__('Config files', 'total-security').' (<strong style="color:#EFA800;">'. __('missing', 'total-security'). '</strong>)</th>';
      echo '</tr></thead>';
      echo '<tbody><tr class="alternate"><td>';
      echo '<div style="font-size: 11px"><strong><em><strong><a href="http://codex.wordpress.org/Using_Permalinks" target="_blank">.htaccess</a></strong></em></strong> <strong style="color:#EFA800;">&#10003;</strong> '.__('If you do not already have this file, create one.', 'total-security').'<br /><strong><em><a href="http://codex.wordpress.org/Editing_wp-config.php" target="_blank">wp-config.php</a></em></strong> <strong style="color:green;">&#10003;</strong> '.__('If your site is working and this file is on this list: congratulations!', 'total-security').'</div></td></tr><td>';
      echo self::list_files($results['missing_conf'], false, false);
      echo '</td></tr></tbody>';
      echo '</table>';
    }

    if ($results['ok']) {
      $diference = $results['total'] - sizeof($results['ok']);
      echo '<div class="fdx-cs-ok" align="center">';
      echo '<h4>'.__('A total of', 'total-security'). ' <span class="sn_count">' . $results['total'] . '</span> '.__('files were scanned', 'total-security').'...</h4><h4> <span class="sn_count">' . sizeof($results['ok']) . '</span> '.__('are unmodified and safe, and', 'total-security'). ' <span class="sn_count">'. $diference .'*</span> '.__('are files modified or missing', 'total-security').  '.</h4>';
      echo '</div>';
      echo '* <em>'.__('Included config files and core files missing "but allowed"', 'total-security'). '.</em>';
    }

    // dialogs
    echo '<div id="source-dialog" style="display: none;" title="File source"><p>'.__('Please wait', 'total-security').'.</p></div>';
    echo '<div id="restore-dialog" style="display: none;" title="'.__('Restore file', 'total-security').'"><p>'.__('Please wait', 'total-security').'.</p></div>';
    ?>

   </div>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="clear"></div>
<script language="JavaScript" type="text/javascript">
/*<![CDATA[*/
jQuery(document).ready(function($){
  $('a.fdx-show-source').click(function() {
     $($(this).attr('href')).dialog('option', { title: '<?php _e('File source', 'total-security') ?>: ' + $(this).attr('data-file'), file_path: $(this).attr('data-file'), file_hash: $(this).attr('data-hash') } ).dialog('open');
      return false;
  });
  $('a.fdx-restore-source').click(function() {
      $($(this).attr('href')).dialog('option', { title: '<?php _e('Restore file source', 'total-security') ?>: ' + $(this).attr('data-file'), file_path: $(this).attr('data-file'), file_hash: $(this).attr('data-hash') } ).dialog('open');
      return false;
  });
  $('#source-dialog').dialog({'dialogClass': 'wp-dialog',
                              'modal': true,
                              'resizable': false,
                              'zIndex': 9999,
                              'width': 800,
                              'height': 550,
                              'hide': 'fade',
                              'open': function(event, ui) { renderSource(event, ui); fixDialogClose(event, ui); },
                              'close': function(event, ui) { jQuery('#source-dialog').html('<p><?php _e('Please wait', 'total-security') ?>.</p>') },
                              'show': 'fade',
                              'autoOpen': false,
                              'closeOnEscape': true
                              });
  $('#restore-dialog').dialog({'dialogClass': 'wp-dialog',
                               'modal': true,
                               'resizable': false,
                               'zIndex': 9999,
                               'width': 450,
                               'height': 350,
                               'hide': 'fade',
                               'open': function(event, ui) { renderRestore(event, ui); fixDialogClose(event, ui); },
                               'close': function(event, ui) { jQuery('#restore-dialog').html('<p><?php _e('Please wait', 'total-security') ?>.</p>') },
                               'show': 'fade',
                               'autoOpen': false,
                               'closeOnEscape': true
                              });
  // scan files
  $('#fdx-run-scan').removeAttr('disabled').click(function(){
    var data = {action: 'sn_core_run_scan'};

    $(this).attr('disabled', 'disabled')
           .val('<?php _e('Scanning files, please wait!', 'total-security') ?>');
    $.blockUI({ message: '<img src="<?php echo FDX2_PLUGIN_URL; ?>images/loading2.gif" width="24" height="24" border="0" alt="" /><br /><?php _e('Total Security this scanning your core files, <br />Please wait, it can take a minute.', 'total-security') ?>' });

    $.post(ajaxurl, data, function(response) {
      if (response != '1') {
        alert('<?php _e('Undocumented error. Page will automatically reload', 'total-security') ?>.');
        window.location.reload();
      } else {
        window.location.reload();
      }
    });
  }); // run tests
}); // onload

function renderSource(event, ui) {
  dialog_id = '#' + event.target.id;

  jQuery.post(ajaxurl, {action: 'sn_core_get_file_source', filename: jQuery('#source-dialog').dialog('option', 'file_path'), hash: jQuery('#source-dialog').dialog('option', 'file_hash')}, function(response) {
      if (response) {
        if (response.err) {
          jQuery(dialog_id).html('<p><b><?php _e('An error occured', 'total-security') ?>.</b> ' + response.err + '</p>');
        } else {
          jQuery(dialog_id).html('<pre class="brush: php"></pre>');
          jQuery('pre', dialog_id).text(response.source);
          jQuery('pre', dialog_id).snippet(response.ext, {style: 'whitengrey'});
        }
      } else {
        alert('<?php _e('An undocumented error occured. The page will reload', 'total-security') ?>.');
        window.location.reload();
      }
    }, 'json');
} // renderSource
function renderRestore(event, ui) {
  dialog_id = '#' + event.target.id;

  jQuery.post(ajaxurl, {action: 'sn_core_restore_file', filename: jQuery(dialog_id).dialog('option', 'file_path'), hash: jQuery(dialog_id).dialog('option', 'file_hash')}, function(response) {
      if (response) {
        if (response.err) {
          jQuery(dialog_id).html('<p><b><?php _e('An error occured', 'total-security') ?>.</b> ' + response.err + '</p>');
        } else {
          jQuery(dialog_id).html(response.out);

            jQuery('#fdx-restore-file').on('click', function(event){
              jQuery(this).attr('disabled', 'disabled').attr('value', '<?php _e('Please wait', 'total-security') ?> ...');
              jQuery.post(ajaxurl, {action: 'sn_core_restore_file_do', filename: jQuery(this).attr('data-filename')}, function(response) {
                if (response == '1') {
                  alert('<?php _e('File successfully restored!\nThe page will reload and files will be rescanned', 'total-security') ?>.');
                  window.location.reload();
                } else {
                  alert('<?php _e('An error occured', 'total-security') ?> - ' + response);
                  jQuery(this).attr('disabled', '').attr('value', '<?php _e('Restore file', 'total-security') ?>');
                }
              });
            });
        }
      } else {
        alert('<?php _e('An undocumented error occured. The page will reload', 'total-security') ?>.');
        window.location.reload();
      }
    }, 'json');
} // renderSource
function fixDialogClose(event, ui) {
  jQuery('.ui-widget-overlay').bind('click', function(){ jQuery('#' + event.target.id).dialog('close'); });
} // fixDialogClose
/*]]>*/
</script>