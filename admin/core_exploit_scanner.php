<?php
  // this plugin requires Last version
        if (!version_compare(get_bloginfo('version'), FDX2_LAST_WP_VER,  '>=')) {
         echo '<div id="message" class="error" style="top: 250px; position: absolute; padding: 15px"><div align="center"><img src="'.FDX2_PLUGIN_URL.'/images/warning.png" width="48" height="48" border="0" alt="" /></div><strong>'.__('Core Exploit Scanner</strong> requires the latest WordPress version', 'fdx-lang').' (<a href="' . admin_url('update-core.php') . '" title="'.__('Update WP core', 'fdx-lang').'">' . FDX2_LAST_WP_VER . '</a>) '.__('to function properly. You\'re using WordPress version', 'fdx-lang').' (<strong>' . get_bloginfo('version') . ')</strong>. '.__('Please', 'fdx-lang'). ' <strong><a href="' . admin_url('update-core.php') . '" title="'.__('Update WP core', 'fdx-lang').'">'.__('update', 'fdx-lang').'</a></strong>.</div>';
    return;
    }

    $results = get_option(FDX_CS_OPTIONS_KEY);
  ?>
<div class="wrap"><?php echo get_screen_icon('fdx-lock');?>
<h2><?php echo FDX2_PLUGIN_NAME;?>: <?php _e('Core Exploit Scanner', 'fdx-lang') ?></h2>
<div id="poststuff">
<div id="post-body" class="metabox-holder columns-2">

<?php include('_sidebar.php'); ?>

<div class="postbox-container">
<div class="meta-box-sortables">

<div class="postbox">
<div class="handlediv" title="<?php _e('Click to toggle', 'fdx-lang') ?>"><br /></div><h3 class='hndle'><span><?php _e('Core Exploit Scanner', 'fdx-lang') ?></span></h3>
<div class="inside">



   <?php
    echo '<p>'.__('Files are scanned and compared via the <em>MD5 hashing algorithm</em> to original WordPress core files available from <strong>wordpress.org</strong>. Not every change on core files is malicious and changes can serve a legitimate purpose. However if you are not a developer and you did not change the files yourself the changes most probably come from an exploit.', 'fdx-lang').'</p>';
    echo '<div align="center"><input type="button" value=" '.__('One Click Scanner', 'fdx-lang'). ' " id="fdx-run-scan" class="button-primary" />';
    if (isset($results['last_run']) && $results['last_run']) {
      echo '<br /><code>'.__('Files were last scanned on', 'fdx-lang').': ' . date(get_option('date_format') . ' ' . get_option('time_format'), $results['last_run']) . '.</code><p>&nbsp;</p>';
    }
    echo '</div>';
    if ($results['changed_bad']) {
      echo '<table class="widefat">';
      echo '<thead><tr>';
      echo '<th class="fdx-status" style="color:red; font-weight: bold">'.__('WP CORE FILES MODIFIED', 'fdx-lang'). '<small></th>';
      echo '</tr></thead>';
      echo '<tbody><tr><td>';
      echo '<p>'.__('If you didn\'t modify the following files and don\'t know who did they are most probably infected by a party malicious code.', 'fdx-lang').'</p>';
      echo self::list_files($results['changed_bad'], true, true);
      echo '</td></tr></tbody>';
      echo '</table>';
    }

    if ($results['missing_bad']) {
      echo '<p>&nbsp;</p><table class="widefat">';
      echo '<thead><tr>';
      echo '<th class="fdx-status" style="color:#EFA800; font-weight: bold">'.__('WP CORE FILES MISSING', 'fdx-lang').'</th>';
      echo '</tr></thead>';
      echo '<tbody><tr><td>';
      echo '<p>'.__('Missing core files my indicate a bad auto-update or they simply were not copied on the server when the site was setup. Use the restore action to create them.', 'fdx-lang').'</p>';
      echo self::list_files($results['missing_bad'], false, true);
      echo '</td></tr></tbody>';
      echo '</table>';
    }

    if ($results['changed_ok']) {
      echo '<p>&nbsp;</p><table class="widefat">';
      echo '<thead><tr>';
      echo '<th class="fdx-status" style="color:#6FBF00; font-weight: bold">'.__('WP CORE FILES MODIFIED', 'fdx-lang').'*</th>';
      echo '</tr></thead>';
      echo '<tbody><tr><td>';
      echo '<p>'.__('There are only 2 core files (<strong><em>/wp-config.php</em></strong> and <strong><em>/.htaccess</em></strong>) that should be modified. This is normal and one or both of them should appear on this list. You can still have a look at their source to check for any suspicious code.', 'fdx-lang').'</p>';
      echo self::list_files($results['changed_ok'], true, false);
      echo '</td></tr></tbody>';
      echo '</table>';
    }
    if ($results['missing_ok']) {
      echo '<p>&nbsp;</p><table class="widefat">';
      echo '<thead><tr>';
      echo '<th class="fdx-status" style="color:#6FBF00; font-weight: bold">'.__('WP CORE FILES MISSING', 'fdx-lang').'*</th>';
      echo '</tr></thead>';
      echo '<tbody><tr><td>';
      echo '<p>'.__('Some files like (<strong><em>/readme.html, /license.txt, /wp-config-sample.php, /wp-admin/install.php, /wp-admin/upgrade.php</em></strong>) are not vital and should be removed. Do not restore them unless you really need them and know what you are doing.', 'fdx-lang').'</p>';
      echo self::list_files($results['missing_ok'], false, true);
      echo '</td></tr></tbody>';
      echo '</table>';
  }

    if ($results['ok']) {
      $diference = $results['total'] - sizeof($results['ok']);
      echo '<div class="fdx-cs-ok" align="center">';
      echo '<h4>'.__('A total of', 'fdx-lang'). ' <span class="sn_count">' . $results['total'] . '</span> '.__('files were scanned', 'fdx-lang').'...</h4><h4> <span class="sn_count">' . sizeof($results['ok']) . '</span> '.__('are unmodified and safe, and', 'fdx-lang'). ' <span class="sn_count">'. $diference .'*</span> '.__('are files modified or missing', 'fdx-lang').  '.</h4>';
      echo '</div>';
      echo '* <em>'.__('Included files modified or missing "but allowed"', 'fdx-lang'). '.</em>';
    }

    // dialogs
    echo '<div id="source-dialog" style="display: none;" title="File source"><p>'.__('Please wait', 'fdx-lang').'.</p></div>';
    echo '<div id="restore-dialog" style="display: none;" title="'.__('Restore file', 'fdx-lang').'"><p>'.__('Please wait', 'fdx-lang').'.</p></div>';
    ?>

   </div>
</div>
</div>
</div>
</div>
</div>

</div>
<?php include('_footer_js.php'); ?>
<div class="clear"></div>
<script language="JavaScript" type="text/javascript">
/*<![CDATA[*/
jQuery(document).ready(function($){
  $('a.fdx-show-source').click(function() {
     $($(this).attr('href')).dialog('option', { title: '<?php _e('File source', 'fdx-lang') ?>: ' + $(this).attr('data-file'), file_path: $(this).attr('data-file'), file_hash: $(this).attr('data-hash') } ).dialog('open');
      return false;
  });
  $('a.fdx-restore-source').click(function() {
      $($(this).attr('href')).dialog('option', { title: '<?php _e('Restore file source', 'fdx-lang') ?>: ' + $(this).attr('data-file'), file_path: $(this).attr('data-file'), file_hash: $(this).attr('data-hash') } ).dialog('open');
      return false;
  });
  $('#source-dialog').dialog({'dialogClass': 'wp-dialog',
                              'modal': true,
                              'resizable': false,
                              'zIndex': 9999,
                              'width': 800,
                              'height': 550,
                              'hide': 'fade',
                              'open': function(event, ui) { renderSource(event, ui); fixDialogClose(event, ui); },
                              'close': function(event, ui) { jQuery('#source-dialog').html('<p><?php _e('Please wait', 'fdx-lang') ?>.</p>') },
                              'show': 'fade',
                              'autoOpen': false,
                              'closeOnEscape': true
                              });
  $('#restore-dialog').dialog({'dialogClass': 'wp-dialog',
                               'modal': true,
                               'resizable': false,
                               'zIndex': 9999,
                               'width': 450,
                               'height': 350,
                               'hide': 'fade',
                               'open': function(event, ui) { renderRestore(event, ui); fixDialogClose(event, ui); },
                               'close': function(event, ui) { jQuery('#restore-dialog').html('<p><?php _e('Please wait', 'fdx-lang') ?>.</p>') },
                               'show': 'fade',
                               'autoOpen': false,
                               'closeOnEscape': true
                              });
  // scan files
  $('#fdx-run-scan').removeAttr('disabled').click(function(){
    var data = {action: 'sn_core_run_scan'};

    $(this).attr('disabled', 'disabled')
           .val('<?php _e('Scanning files, please wait!', 'fdx-lang') ?>');
    $.blockUI({ message: '<img src="<?php echo FDX2_PLUGIN_URL; ?>images/loading2.gif" width="24" height="24" border="0" alt="" /><br /><?php _e('Total Security this scanning your core files, <br />Please wait, it can take a minute.', 'fdx-lang') ?>' });

    $.post(ajaxurl, data, function(response) {
      if (response != '1') {
        alert('<?php _e('Undocumented error. Page will automatically reload', 'fdx-lang') ?>.');
        window.location.reload();
      } else {
        window.location.reload();
      }
    });
  }); // run tests
}); // onload

function renderSource(event, ui) {
  dialog_id = '#' + event.target.id;

  jQuery.post(ajaxurl, {action: 'sn_core_get_file_source', filename: jQuery('#source-dialog').dialog('option', 'file_path'), hash: jQuery('#source-dialog').dialog('option', 'file_hash')}, function(response) {
      if (response) {
        if (response.err) {
          jQuery(dialog_id).html('<p><b><?php _e('An error occured', 'fdx-lang') ?>.</b> ' + response.err + '</p>');
        } else {
          jQuery(dialog_id).html('<pre class="brush: php"></pre>');
          jQuery('pre', dialog_id).text(response.source);
          jQuery('pre', dialog_id).snippet(response.ext, {style: 'whitengrey'});
        }
      } else {
        alert('<?php _e('An undocumented error occured. The page will reload', 'fdx-lang') ?>.');
        window.location.reload();
      }
    }, 'json');
} // renderSource
function renderRestore(event, ui) {
  dialog_id = '#' + event.target.id;

  jQuery.post(ajaxurl, {action: 'sn_core_restore_file', filename: jQuery(dialog_id).dialog('option', 'file_path'), hash: jQuery(dialog_id).dialog('option', 'file_hash')}, function(response) {
      if (response) {
        if (response.err) {
          jQuery(dialog_id).html('<p><b><?php _e('An error occured', 'fdx-lang') ?>.</b> ' + response.err + '</p>');
        } else {
          jQuery(dialog_id).html(response.out);

            jQuery('#fdx-restore-file').on('click', function(event){
              jQuery(this).attr('disabled', 'disabled').attr('value', '<?php _e('Please wait', 'fdx-lang') ?> ...');
              jQuery.post(ajaxurl, {action: 'sn_core_restore_file_do', filename: jQuery(this).attr('data-filename')}, function(response) {
                if (response == '1') {
                  alert('<?php _e('File successfully restored!\nThe page will reload and files will be rescanned', 'fdx-lang') ?>.');
                  window.location.reload();
                } else {
                  alert('<?php _e('An error occured', 'fdx-lang') ?> - ' + response);
                  jQuery(this).attr('disabled', '').attr('value', '<?php _e('Restore file', 'fdx-lang') ?>');
                }
              });
            });
        }
      } else {
        alert('<?php _e('An undocumented error occured. The page will reload', 'fdx-lang') ?>.');
        window.location.reload();
      }
    }, 'json');
} // renderSource
function fixDialogClose(event, ui) {
  jQuery('.ui-widget-overlay').bind('click', function(){ jQuery('#' + event.target.id).dialog('close'); });
} // fixDialogClose
/*]]>*/
</script>