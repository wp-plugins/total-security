<div class="wrap"><?php echo get_screen_icon('fdx-lock');?>
<h2><?php echo FDX2_PLUGIN_NAME;?>: <?php _e('Vulnerability Scan', 'fdx-lang') ?></h2>
<?php
 /* display warning if test were never run
*------------------------------------------------------------*/
    $tests = get_option(FDX_OPTIONS_KEY);
    if (!$tests['last_run']) {
      echo '<div id="message" class="error"><p>Total Security '.__('(Vulnerability Scan) <strong>tests were never run.</strong> Click <strong>"'.__('One Click Scan', 'fdx-lang').'"</strong> to run them now and analyze your site for security vulnerabilities.', 'fdx-lang').'</p></div>';
    } elseif ((current_time('timestamp') - 15*24*60*60) > $tests['last_run']) {
      echo '<div id="message" class="error"><p>Total Security '.__('(Vulnerability Scan) <strong>tests were not run for more than 30 days.</strong> It\'s advisable to run them once in a while. Click <strong>"'.__('One Click Scan', 'fdx-lang').'"</strong> to run them now and analyze your site for security vulnerabilities.', 'fdx-lang').'</p></div>';
    }
?>
<div id="poststuff">
<div id="post-body" class="metabox-holder columns-2">

<?php include('_sidebar.php'); ?>

<div class="postbox-container">
<div class="meta-box-sortables">

<div class="postbox">
<div class="handlediv" title="<?php _e('Click to toggle', 'fdx-lang') ?>"><br /></div><h3 class='hndle'><span><?php _e('Vulnerability Scan', 'fdx-lang') ?></span></h3>
<div class="inside">
<?php
    // get test results from cache
    $tests = get_option(FDX_OPTIONS_KEY);
        echo '&nbsp;';

    echo '<div align="center"><input type="submit" value=" '.__('One Click Scan', 'fdx-lang').' " id="run-tests" class="button-primary" name="Submit" />';

    if ($tests['last_run']) {
      echo '<br /><code>'.__('Last scan run on', 'fdx-lang').': ' . date(get_option('date_format') . ' ' . get_option('time_format'), $tests['last_run']) . '.</code>';
    } else { echo '<p><img src="'.FDX2_PLUGIN_URL.'/images/no.png" width="48" height="48" border="0" alt="" /></p>';}

    echo '</div><br />';


    if ($tests['last_run']) {
      echo '<table class="widefat">';
      echo '<thead><tr>';
      echo '<th class="fdx-status" style="width: 40px"></th>';
      echo '<th class="fdx-status">'.__('Results', 'fdx-lang').'</th>';
      echo '<th>&nbsp;</th>';
      echo '</tr></thead>';
      echo '<tbody>';

      if (is_array($tests['test'])) {
        // test Results
        foreach($tests['test'] as $test_name => $details) {
          echo '<tr>
                  <td class="fdx-status">' . self::status($details['status']) . '</td>

                  <td class="fdx-details">' . $details['msg'] . '</td>
                  <td class="fdx-status"><a href="http://fabrix.net/total-security/mscan/#' . $test_name . '" class="button" target="_blank" title="'.__('Details, tips &amp; help', 'fdx-lang').'"><strong>?</strong></a>&nbsp;</td>
                </tr>';
        } // foreach ($tests)
      } else { // no test results
        echo '<tr>
                <td colspan="4">'.__('No test results are available. Click "Run tests" to run tests now.', 'fdx-lang'). '</td>
              </tr>';
      } // if tests

      echo '</tbody>';
      echo '</table>';
    } // if $results
?>
   </div>
</div>

</div> <!-- /postbox-container -->
</div><!-- /meta-box-sortables -->



</div><!-- /post-body -->
</div><!-- /poststuff -->


</div><!-- /wrap -->


<div class="clear"></div>
<script language="JavaScript" type="text/javascript">
/*<![CDATA[*/
jQuery(document).ready(function($){
  // just to make sure the button is not stuck
  $('#run-tests').removeAttr('disabled');
  // run tests, via ajax
  $('#run-tests').click(function(){
    var data = {action: 'sn_run_tests'};
     $(this).attr('disabled', 'disabled')
           .val('<?php _e('Running tests, please wait!', 'fdx-lang') ?>');
    $.blockUI({ message: '<img src="<?php echo FDX2_PLUGIN_URL; ?>images/loading.gif" width="24" height="24" border="0" alt="" /><br /><?php _e('Total Security is analyzing your site.<br />Please wait, it can take a few minutes.', 'fdx-lang') ?>' });
    $.post(ajaxurl, data, function(response) {
          window.location.reload();
    });
  }); // run tests
});
/*]]>*/
</script>
