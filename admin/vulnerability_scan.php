<div class="wrap"><?php echo get_screen_icon('sn-lock');?>
<h2><?php echo FDX2_PLUGIN_NAME;?>: <?php _e('Vulnerability Scan', 'fdx-lang') ?></h2>
<div id="poststuff">
<div id="post-body" class="metabox-holder columns-2">

<?php include('_sidebar.php'); ?>

<div class="postbox-container">
<div class="meta-box-sortables">

<div class="postbox">
<div class="handlediv" title="<?php _e('Click to toggle', 'fdx-lang') ?>"><br /></div><h3 class='hndle'><span><?php _e('Vulnerability Scan', 'fdx-lang') ?></span></h3>
<div class="inside">
<?php
    // get test results from cache
    $tests = get_option(FDX_OPTIONS_KEY);
        echo '&nbsp;';

    echo '<div align="center"><input type="submit" value=" One Click Scan " id="run-tests" class="button-primary" name="Submit" />';

    if ($tests['last_run']) {
      echo '<br /><code>Tests were last run on: ' . date(get_option('date_format') . ' ' . get_option('time_format'), $tests['last_run']) . '.</code>';
    }

    echo '</div>&nbsp;';


    if ($tests['last_run']) {
      echo '<table class="widefat" id="fdx-table">';
      echo '<thead><tr>';
      echo '<th class="sn-status">Status</th>';
      echo '<th>Test description</th>';
      echo '<th>Test results</th>';
      echo '<th>&nbsp;</th>';
      echo '</tr></thead>';
      echo '<tbody>';

      if (is_array($tests['test'])) {
        // test Results
        foreach($tests['test'] as $test_name => $details) {
          echo '<tr>
                  <td class="sn-status">' . self::status($details['status']) . '</td>
                  <td>' . $details['title'] . '</td>
                  <td>' . $details['msg'] . '</td>
                  <td><a href="http://fabrix.net/total-security/wpss/#' . $test_name . '" class="sn-details button" target="_blank" title="Details, tips &amp; help"><strong>?</strong></a></td>
                </tr>';
        } // foreach ($tests)
      } else { // no test results
        echo '<tr>
                <td colspan="4">No test results are available. Click "Run tests" to run tests now.</td>
              </tr>';
      } // if tests

      echo '</tbody>';
      echo '</table>';
    } // if $results
?>
   </div>
</div>

</div> <!-- /postbox-container -->
</div><!-- /meta-box-sortables -->



</div><!-- /post-body -->
</div><!-- /poststuff -->


</div><!-- /wrap -->



<?php include('_footer_js.php'); ?>
<div class="clear"></div>
<script language="JavaScript" type="text/javascript">
/*<![CDATA[*/
jQuery(document).ready(function($){
  // just to make sure the button is not stuck
  $('#run-tests').removeAttr('disabled');
  // run tests, via ajax
  $('#run-tests').click(function(){
    var data = {action: 'sn_run_tests'};
     $(this).attr('disabled', 'disabled')
           .val('Running tests, please wait!');
    $.blockUI({ message: '<img src="<?php echo FDX_WPSS_PLUGIN_URL; ?>images/loading.gif" width="24" height="24" border="0" alt="" /><br />Total Security is analyzing your site.<br />Please wait, it can take a few minutes.' });
    $.post(ajaxurl, data, function(response) {
          window.location.reload();
    });
  }); // run tests
});
/*]]>*/
</script>
